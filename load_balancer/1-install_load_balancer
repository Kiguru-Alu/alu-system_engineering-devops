#!/usr/bin/env bash
# Idempotent script to install and configure HAProxy load balancer (roundrobin)

# --- 1. INSTALL HAPROXY ONLY IF NOT INSTALLED ---
if ! command -v haproxy >/dev/null 2>&1; then
    echo "HAProxy not found. Installing..."
    apt-get update -y
    apt-get install -y haproxy
else
    echo "HAProxy already installed."
fi

# --- 2. ENABLE HAPROXY SERVICE IF NOT ENABLED ---
HAPROXY_DEFAULT="/etc/default/haproxy"

if grep -q "ENABLED=1" "$HAPROXY_DEFAULT"; then
    echo "HAProxy already enabled."
else
    echo "Enabling HAProxy service..."
    sed -i 's/ENABLED=0/ENABLED=1/' "$HAPROXY_DEFAULT" || echo "ENABLED=1" >> "$HAPROXY_DEFAULT"
fi

# --- 3. CONFIGURE HAPROXY ONLY IF CONFIG NOT ALREADY APPLIED ---
HAPROXY_CFG="/etc/haproxy/haproxy.cfg"

# Check if config already contains your backend servers
if grep -q "6845-web-01" "$HAPROXY_CFG"; then
    echo "HAProxy config already contains backend configuration. Skipping rewrite."
else
    echo "Writing HAProxy configuration..."

    cat <<EOF | sudo tee "$HAPROXY_CFG" > /dev/null
global 
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    balance roundrobin
    server 6845-web-01 54.172.16.102:80 check
    server 6845-web-02 18.233.224.205:80 check
    http-response set-header X-Served-By %[srv_name]
EOF

fi

# --- 4. RESTART OR START HAPROXY SERVICE ---
if systemctl is-active --quiet haproxy; then
    echo "Restarting HAProxy..."
    systemctl restart haproxy
else
    echo "Starting HAProxy..."
    systemctl start haproxy
fi

echo "HAProxy setup complete!"

